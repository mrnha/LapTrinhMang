<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Chat App</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- SockJS -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <!-- STOMP -->
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: #f5f6fa;
        }
        .main-chat-wrapper {
            height: 100vh;
            display: flex;
            flex-direction: row;
            background: #f5f6fa;
        }
        .sidebar {
            width: 320px;
            min-width: 240px;
            max-width: 100vw;
            background: #fff;
            border-right: 1px solid #dee2e6;
            display: flex;
            flex-direction: column;
            height: 100vh;
            z-index: 2;
        }
        .sidebar .list-group {
            border: none;
            border-radius: 0;
        }
        .sidebar .tab-content {
            flex: 1;
            overflow-y: auto;
            background: #fff;
        }
        .friend-list-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem 0.5rem 1.5rem;
            border-bottom: 1px solid #eee;
            background: #fff;
        }
        .friend-list {
            padding: 0.5rem 1rem 1rem 1rem;
            overflow-y: auto;
            max-height: calc(100vh - 180px);
        }
        .friend-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .friend-item.selected, .friend-item:hover {
            background: #f1f3f7;
        }
        .friend-avatar img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #e9ecef;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: -15px;
            margin-top: 25px;
            border: 2px solid #fff;
            position: absolute;
        }
        .status-indicator.online { background: #28a745; }
        .status-indicator.offline { background: #adb5bd; }
        .friend-info { display: flex; flex-direction: column; }
        .friend-name { font-weight: 500; }
        .friend-status { font-size: 0.85rem; color: #888; }
        .add-friend-btn {
            background: #007bff;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .add-friend-btn:hover { background: #0056b3; }

        /* Chat area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: #f5f6fa;
        }
        .chat-header {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            background: #007bff;
            color: #fff;
            font-weight: 500;
            font-size: 1.1rem;
            border-bottom: 1px solid #dee2e6;
            min-height: 60px;
        }
        .chat-title { flex: 1; }
        .back-button {
            display: none;
            background: none;
            border: none;
            color: #fff;
            font-size: 1.3rem;
            margin-right: 1rem;
            cursor: pointer;
        }
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            background: #f5f6fa;
        }
        .message {
            max-width: 70%;
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            position: relative;
            word-break: break-word;
            margin-bottom: 1rem;
        }
        .message-sender {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .sender-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 0.5rem;
            object-fit: cover;
        }
        .sender-name {
            font-size: 0.9rem;
            font-weight: 500;
            color: #666;
        }
        .message.sent {
            align-self: flex-end;
            background: #007bff;
            color: #fff;
        }
        .message.sent .message-sender {
            justify-content: flex-end;
        }
        .message.sent .sender-avatar {
            margin-right: 0;
            margin-left: 0.5rem;
            order: 2;
        }
        .message.sent .sender-name {
            order: 1;
        }
        .message.received {
            align-self: flex-start;
            background: #e9ecef;
            color: #212529;
        }
        .message-content {
            position: relative;
        }
        .message-text {
            margin: 0.25rem 0;
        }
        .message-time {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 0.25rem;
        }
        .chat-input-container {
            display: flex;
            gap: 0.5rem;
            padding: 1rem 1.5rem;
            background: #fff;
            border-top: 1px solid #dee2e6;
        }
        .message-input {
            flex: 1;
            padding: 0.5rem 1rem;
            border: 1px solid #dee2e6;
            border-radius: 1.5rem;
            outline: none;
            font-size: 1rem;
        }
        .send-button {
            width: 2.5rem;
            height: 2.5rem;
            border: none;
            border-radius: 50%;
            background: #007bff;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.1rem;
        }
        .send-button:active { transform: scale(0.95); }
        /* Responsive */
        @media (max-width: 991.98px) {
            .main-chat-wrapper { flex-direction: column; }
            .sidebar { width: 100vw; min-width: 0; max-width: 100vw; height: auto; border-right: none; border-bottom: 1px solid #dee2e6; }
            .chat-area { height: auto; }
        }
        @media (max-width: 768px) {
            .main-chat-wrapper { flex-direction: column; }
            .sidebar { width: 100vw; min-width: 0; max-width: 100vw; height: auto; border-right: none; border-bottom: 1px solid #dee2e6; }
            .chat-area { height: auto; }
            .back-button { display: block; }
        }
        .chat-actions {
            margin-left: auto;
            display: flex;
            gap: 0.5rem;
        }
        .room-message {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin-bottom: 1.2rem;
            max-width: 70%;
            padding: 0.75rem 1.1rem;
            border-radius: 1rem;
            background: #e9ecef;
            color: #212529;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
            position: relative;
            word-break: break-word;
        }
        .room-message .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 0.7rem;
            border: 2px solid #fff;
            background: #f5f6fa;
        }
        .room-message .message-content {
            flex: 1;
        }
        .room-message .sender-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.1rem;
            color: #007bff;
        }
        .room-message .message-time {
            font-size: 0.8rem;
            color: #888;
            margin-top: 0.2rem;
        }
        .room-message.sent {
            margin-left: auto;
            background: #007bff;
            color: #fff;
            flex-direction: row-reverse;
        }
        .room-message.sent .sender-name {
            color: #fff;
            text-align: right;
        }
        .room-message.sent .message-time {
            color: #e0e0e0;
            text-align: right;
        }
        .room-message.sent .avatar {
            margin-left: 0.7rem;
            margin-right: 0;
        }
        .room-message.received {
            margin-right: auto;
            background: #e9ecef;
            color: #212529;
        }
        .room-message.received .sender-name {
            color: #007bff;
            text-align: left;
        }
        .room-message.received .message-time {
            color: #888;
            text-align: left;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Chat App</a>
            <div class="d-flex">
                <span class="navbar-text me-3">
                    Welcome, <span id="currentUsername"></span>
                </span>
                <a href="/profile" class="btn btn-outline-light me-2">
                    <i class="fas fa-user-cog"></i> Profile
                </a>
                <form th:action="@{/logout}" method="post" class="d-inline">
                    <button type="submit" class="btn btn-outline-light">Logout</button>
                </form>
            </div>
        </div>
    </nav>

    <div class="main-chat-wrapper">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="list-group list-group-flush">
                <a href="#" class="list-group-item list-group-item-action active" data-bs-toggle="list" data-bs-target="#friends">
                    <i class="fas fa-users me-2"></i>Friends
                </a>
                <a href="#" class="list-group-item list-group-item-action" data-bs-toggle="list" data-bs-target="#rooms">
                    <i class="fas fa-comments me-2"></i>Rooms
                </a>
                <a href="#" class="list-group-item list-group-item-action" data-bs-toggle="list" data-bs-target="#friendRequests">
                    <i class="fas fa-user-plus me-2"></i>Friend Requests
                </a>
                <a href="#" class="list-group-item list-group-item-action" data-bs-toggle="list" data-bs-target="#onlineUsers">
                    <i class="fas fa-circle text-success me-2"></i>Online Users
                </a>
                <a href="#" class="list-group-item list-group-item-action" data-bs-toggle="list" data-bs-target="#searchUsers">
                    <i class="fas fa-search me-2"></i>Find Friends
                </a>
            </div>
            <div class="tab-content">
                <!-- Friends List -->
                <div class="tab-pane fade show active" id="friends">
                    <div class="friend-list-header">
                        <h3>Friends</h3>
                        <button class="add-friend-btn" onclick="showAddFriendModal()">
                            <i class="fas fa-user-plus"></i>
                        </button>
                    </div>
                    <div class="friend-list" id="friend-list">
                        <!-- Danh sách bạn bè sẽ được load ở đây -->
                    </div>
                </div>
                <!-- Rooms List -->
                <div class="tab-pane fade" id="rooms">
                    <div class="friend-list-header">
                        <h3>Rooms</h3>
                        <button class="add-friend-btn" data-bs-toggle="modal" data-bs-target="#createRoomModal">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="friend-list" id="room-list">
                        <!-- Danh sách phòng chat sẽ được load ở đây -->
                    </div>
                </div>
                <!-- Friend Requests -->
                <div class="tab-pane fade" id="friendRequests">
                    <div id="friendRequests" class="list-group list-group-flush">
                        <div class="text-center text-muted p-3">Đang tải lời mời kết bạn...</div>
                    </div>
                </div>
                <!-- Online Users -->
                <div class="tab-pane fade" id="onlineUsers">
                    <div class="p-3">
                        <h6 class="mb-3">Online Users</h6>
                        <div id="onlineUsersList" class="list-group list-group-flush">
                            <div class="text-center text-muted p-3">Đang tải danh sách người dùng online...</div>
                        </div>
                    </div>
                </div>
                <!-- Search Users -->
                <div class="tab-pane fade" id="searchUsers">
                    <div class="p-3">
                        <div class="input-group mb-3">
                            <input type="text" id="searchInput" class="form-control" placeholder="Tìm kiếm người dùng...">
                            <button class="btn btn-outline-secondary" type="button" onclick="searchUsers()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <div id="searchResults" class="list-group list-group-flush">
                            <div class="text-center text-muted p-3">Nhập tên người dùng để tìm kiếm</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Chat Area -->
        <div class="chat-area">
            <div class="chat-header">
                <button class="back-button" onclick="showFriendList()">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <span class="chat-title">Select a friend to start chatting</span>
                <div class="chat-actions">
                    <button id="unfriendButton" class="btn btn-danger btn-sm d-none" onclick="unfriendUser()">
                        <i class="fas fa-user-minus"></i> Unfriend
                    </button>
                    <button id="deleteRoomButton" class="btn btn-danger btn-sm d-none" onclick="deleteRoom()">
                        <i class="fas fa-trash"></i> Delete Room
                    </button>
                </div>
            </div>
            <div id="messages" class="messages"></div>
            <div class="chat-input-container">
                <input type="text" id="message-input" class="message-input" placeholder="Type a message...">
                <button id="send-button" class="send-button">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container position-fixed bottom-0 end-0 p-3"></div>

    <!-- Modal Thêm bạn -->
    <div class="modal fade" id="addFriendModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Thêm bạn mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addFriendForm">
                        <div class="mb-3">
                            <label for="searchQuery" class="form-label">Tìm kiếm người dùng</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="searchQuery" placeholder="Nhập tên hoặc username...">
                                <button type="button" class="btn btn-outline-secondary" onclick="searchUsers()">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div id="searchResults" class="list-group">
                                <!-- Kết quả tìm kiếm sẽ được thêm vào đây -->
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Room Modal -->
    <div class="modal fade" id="createRoomModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tạo phòng chat mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createRoomForm">
                        <div class="mb-3">
                            <label for="roomName" class="form-label">Tên phòng</label>
                            <input type="text" class="form-control" id="roomName" required>
                        </div>
                        <div class="mb-3">
                            <label for="roomDescription" class="form-label">Mô tả</label>
                            <textarea class="form-control" id="roomDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Thành viên</label>
                            <div id="memberSelection" class="border rounded p-3" style="max-height: 200px; overflow-y: auto;"></div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Đóng</button>
                            <button type="submit" class="btn btn-primary">Tạo phòng</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Thông báo lời mời kết bạn -->
    <div class="modal fade" id="friendRequestModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Lời mời kết bạn mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="friendRequestContent">
                        <!-- Nội dung thông báo sẽ được thêm vào đây -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-danger" onclick="rejectFriendRequest()">Từ chối</button>
                    <button type="button" class="btn btn-success" onclick="acceptFriendRequest()">Đồng ý</button>
                </div>
            </div>
        </div>
    </div>

    <!-- User Data -->
    <div id="userData"
         th:data-user-id="${#authentication.principal.user.id}"
         th:data-username="${#authentication.principal.user.username}"
         th:data-display-name="${#authentication.principal.user.displayName}"
         th:data-avatar-url="${#authentication.principal.user.avatarUrl}"
         style="display: none;">
    </div>

    <script th:inline="javascript">
        let currentUserId = [[${#authentication.principal.id}]];
        let currentUsername = [[${#authentication.principal.username}]];
        let currentUserDisplayName = [[${#authentication.principal.user.displayName}]];
        let currentUserAvatar = [[${#authentication.principal.user.avatarUrl}]];
        window.stompClient = null;
        let selectedFriendId = null;
        let selectedFriendUsername = null;
        let isConnecting = false;

        // Disable nút gửi khi chưa kết nối WebSocket
        const sendButton = document.getElementById('send-button');
        if (sendButton) sendButton.disabled = true;

        function connectWebSocket() {
            if (window.stompClient && window.stompClient.connected) {
                console.log('WebSocket is already connected.');
                return;
            }
            if (isConnecting) {
                console.log('WebSocket connection is already in progress.');
                return;
            }
            isConnecting = true;
            showToast('info', 'Đang kết nối tới server chat...');
            const socket = new SockJS('/ws');
            window.stompClient = Stomp.over(socket);
            window.stompClient.debug = null;
            console.log('connectWebSocket: window.stompClient created', window.stompClient);
            window.stompClient.connect({}, function(frame) {
                isConnecting = false;
                console.log('Connected to WebSocket');
                if (sendButton) sendButton.disabled = false;
                window.stompClient.subscribe('/user/queue/messages', onMessageReceived);
                window.stompClient.subscribe('/user/queue/typing', onTypingReceived);
                window.stompClient.subscribe('/topic/online-users', onOnlineStatusReceived);
                loadRooms();
                showToast('success', 'Kết nối chat thành công');
                if (window.pendingRoom) {
                    const room = window.pendingRoom;
                    window.pendingRoom = null;
                    setTimeout(() => {
                        selectRoom(room.id, room.name);
                    }, 100);
                }
            }, function(error) {
                isConnecting = false;
                showToast('error', 'Không thể kết nối đến server chat');
                setTimeout(connectWebSocket, 5000);
            });
            socket.onclose = function() {
                isConnecting = false;
                if (sendButton) sendButton.disabled = true;
                showToast('warning', 'Mất kết nối, đang thử kết nối lại...');
                window.stompClient = null;
                console.log('WebSocket connection closed, window.stompClient set to null');
                setTimeout(connectWebSocket, 5000);
            };
        }

        // Hàm mã hóa tin nhắn bằng public key của người nhận (chỉ cho tin nhắn ngắn)
        async function encryptMessageForUser(username, message) {
            if (message.length > 190) {
                throw new Error('Tin nhắn quá dài để mã hóa bằng RSA!');
            }
            try {
                const res = await fetch(`/api/users/${username}/public-key`);
                if (!res.ok) {
                    throw new Error('Không lấy được public key (user chưa upload hoặc không tồn tại)');
                }
                const data = await res.json();
                if (!data.publicKey) {
                    throw new Error('User chưa upload public key');
                }
                const publicKey = data.publicKey;
                const publicKeyBuffer = Uint8Array.from(atob(publicKey), c => c.charCodeAt(0));
                const importedPublicKey = await window.crypto.subtle.importKey(
                    "spki",
                    publicKeyBuffer,
                    { name: "RSA-OAEP", hash: "SHA-256" },
                    false,
                    ["encrypt"]
                );
                const enc = new TextEncoder();
                const encrypted = await window.crypto.subtle.encrypt(
                    { name: "RSA-OAEP" },
                    importedPublicKey,
                    enc.encode(message)
                );
                return btoa(String.fromCharCode(...new Uint8Array(encrypted)));
            } catch (e) {
                console.error('Lỗi mã hóa:', e);
                throw e;
            }
        }

        // Hàm giải mã tin nhắn
        async function decryptMessage(encryptedBase64) {
            try {
                const privateKeyBase64 = localStorage.getItem('privateKey');
                if (!privateKeyBase64) throw new Error('Chưa có private key');
                const privateKeyBuffer = Uint8Array.from(atob(privateKeyBase64), c => c.charCodeAt(0));
                const importedPrivateKey = await window.crypto.subtle.importKey(
                    "pkcs8",
                    privateKeyBuffer,
                    { name: "RSA-OAEP", hash: "SHA-256" },
                    false,
                    ["decrypt"]
                );
                const encryptedBuffer = Uint8Array.from(atob(encryptedBase64), c => c.charCodeAt(0));
                const decrypted = await window.crypto.subtle.decrypt(
                    { name: "RSA-OAEP" },
                    importedPrivateKey,
                    encryptedBuffer
                );
                return new TextDecoder().decode(decrypted);
            } catch (e) {
                console.error('Lỗi giải mã:', e);
                return null; // Trả về null nếu giải mã thất bại
            }
        }

        // Hàm gửi tin nhắn (có mã hóa)
        async function sendMessage() {
            if (!window.stompClient || !window.stompClient.connected) {
                showToast('error', 'WebSocket chưa kết nối, vui lòng đợi hoặc tải lại trang!');
                return;
            }
            if (!currentUserId || !selectedFriendId) {
                showToast('error', 'Vui lòng chọn bạn bè để chat!');
                return;
            }

            const messageInput = document.getElementById('message-input');
            const content = messageInput.value.trim();
            if (!content) {
                showToast('error', 'Tin nhắn không được để trống');
                return;
            }
            if (content.length > 190) {
                showToast('error', 'Tin nhắn quá dài để mã hóa bằng RSA!');
                return;
            }

            let friendUsername = selectedFriendUsername;
            if (!friendUsername) {
                showToast('error', 'Không xác định được username của bạn bè!');
                return;
            }

            // Mã hóa nội dung tin nhắn
            let encryptedContent;
            try {
                encryptedContent = await encryptMessageForUser(friendUsername, content);
            } catch (e) {
                showToast('error', 'Lỗi mã hóa tin nhắn!');
                return;
            }

            // Tạo đối tượng tin nhắn
            const messageData = {
                sender: currentUserId.toString(),
                receiver: selectedFriendId.toString(),
                content: encryptedContent,
                encrypted: true // Đánh dấu là đã mã hóa
            };

            // Gửi tin nhắn qua WebSocket
            window.stompClient.send("/app/chat.private", {}, JSON.stringify(messageData));

            // Hiển thị tin nhắn ngay lập tức cho người gửi (hiển thị bản rõ)
            displayMessage({
                senderId: currentUserId,
                receiverId: selectedFriendId,
                content: content, // bản rõ
                senderUsername: currentUsername,
                senderDisplayName: currentUserDisplayName,
                senderAvatarUrl: currentUserAvatar,
                timestamp: new Date().getTime()
            }, true);

            // Xóa nội dung input
            messageInput.value = '';
        }

        // Hiển thị tin nhắn
        function displayMessage(messageData, isSent) {
            const messagesContainer = document.getElementById('messages');
            if (!messagesContainer) return;

            const messageElement = document.createElement('div');
            messageElement.className = `message ${isSent ? 'sent' : 'received'}`;
            
            // Format thời gian
            let timeStr;
            try {
                const timestamp = messageData.timestamp ? new Date(messageData.timestamp) : new Date();
                timeStr = timestamp.toLocaleDateString('vi-VN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                }) + ' ' + timestamp.toLocaleTimeString('vi-VN', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            } catch (e) {
                console.error('Error formatting time:', e);
                timeStr = new Date().toLocaleTimeString();
            }

            // Xác định tên và avatar người gửi
            const senderName = messageData.senderDisplayName || messageData.senderUsername || 'Unknown';
            const avatarUrl = messageData.senderAvatarUrl || '/images/default-avatar.png';

            messageElement.innerHTML = `
                <div class="message-content">
                    <div class="message-sender">
                        <img src="${avatarUrl}" 
                             class="sender-avatar" 
                             alt="${senderName}"
                             onerror="this.src='/images/default-avatar.png'">
                        <span class="sender-name">${senderName}</span>
                    </div>
                    <div class="message-text">${messageData.content || ''}</div>
                    <div class="message-time">${timeStr}</div>
                </div>
            `;
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Load tin nhắn
        async function loadMessages(friendId) {
            console.log('Loading messages for friend:', friendId);
            const messagesContainer = document.getElementById('messages');
            if (!messagesContainer) return;
            messagesContainer.innerHTML = '';
            try {
                const response = await fetch(`/api/chat/history/${friendId}`);
                if (!response.ok) throw new Error('Failed to load messages');
                const messages = await response.json();
                for (const message of messages) {
                    let content = message.content;
                    if (message.encrypted) {
                        const decrypted = await decryptMessage(message.content);
                        if (decrypted !== null) content = decrypted;
                    }
                    const isSent = message.senderId === currentUserId;
                    displayMessage({
                        senderId: message.senderId,
                        receiverId: message.receiverId,
                        content: content,
                        senderUsername: isSent ? currentUsername : (message.senderUsername || message.sender?.username || 'Unknown'),
                        senderDisplayName: isSent ? currentUserDisplayName : (message.senderDisplayName || message.sender?.displayName || 'Unknown'),
                        senderAvatarUrl: isSent ? currentUserAvatar : (message.senderAvatarUrl || message.sender?.avatarUrl || '/images/default-avatar.png'),
                        timestamp: message.timestamp
                    }, isSent);
                }
            } catch (error) {
                console.error('Error loading messages:', error);
                showToast('error', 'Failed to load messages');
            }
        }

        // Xử lý tin nhắn nhận được
        async function onMessageReceived(payload) {
            const messageData = JSON.parse(payload.body);
            let content = messageData.content;
            if (messageData.encrypted) {
                const decrypted = await decryptMessage(messageData.content);
                if (decrypted !== null) content = decrypted;
            }
            console.log('Message received:', messageData);
            
            // Chỉ hiển thị tin nhắn nếu đang chat với người gửi
            if (selectedFriendId && 
                (parseInt(messageData.senderId) === parseInt(selectedFriendId) || 
                 parseInt(messageData.receiverId) === parseInt(selectedFriendId))) {
                const isSent = parseInt(messageData.senderId) === parseInt(currentUserId);
                displayMessage({
                    ...messageData,
                    content: content,
                    senderUsername: isSent ? currentUsername : (messageData.senderUsername || messageData.sender?.username || 'Unknown'),
                    senderDisplayName: isSent ? currentUserDisplayName : (messageData.senderDisplayName || messageData.sender?.displayName || 'Unknown'),
                    senderAvatarUrl: isSent ? currentUserAvatar : (messageData.senderAvatarUrl || messageData.sender?.avatarUrl || '/images/default-avatar.png')
                }, isSent);
            }
        }

        // Khởi tạo khi trang load
        document.addEventListener('DOMContentLoaded', function() {
            generateAndUploadKeyPairIfNeeded();
            // Hiển thị tên người dùng hiện tại
            const currentUsernameSpan = document.getElementById('currentUsername');
            if (currentUsernameSpan) {
                currentUsernameSpan.textContent = currentUserDisplayName || currentUsername;
            }

            // Kết nối WebSocket
            connectWebSocket();

            // Sự kiện gửi tin nhắn
            const sendButton = document.getElementById('send-button');
            if (sendButton) {
                sendButton.addEventListener('click', function() {
                    if (window.selectedRoomId) {
                        sendRoomMessage();
                    } else {
                        sendMessage();
                    }
                });
            }

            // Sự kiện nhấn Enter
            const messageInput = document.getElementById('message-input');
            if (messageInput) {
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault(); // Ngăn không cho xuống dòng
                        if (window.selectedRoomId) {
                            sendRoomMessage();
                        } else {
                            sendMessage();
                        }
                    }
                });
            }

            // Load danh sách bạn bè
            loadFriends();
        });

        // Khởi tạo biến toàn cục
        let currentUser = null;
        let selectedUser = null;
        let selectedRoom = null;

        // Hàm lấy CSRF token
        function getCsrfToken() {
            const token = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
            const header = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
            if (!token || !header) {
                console.error('CSRF token not found');
                return null;
            }
            return { token, header };
        }

        // Xử lý thông báo đang nhập
        function onTypingReceived(payload) {
            const typing = JSON.parse(payload.body);
            console.log('Typing status:', typing);
            
            if (typing.sender === selectedUser?.username) {
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) {
                    typingIndicator.textContent = typing.typing ? 'Đang nhập...' : '';
                    typingIndicator.style.display = typing.typing ? 'block' : 'none';
                }
            }
        }

        // Xử lý thông báo trạng thái online
        function onOnlineStatusReceived(payload) {
            const status = JSON.parse(payload.body);
            console.log('Online status:', status);
            loadFriends(); // Reload lại danh sách bạn bè khi có sự kiện online/offline
            // updateUserStatus(status.username, status.online); // Có thể bỏ nếu loadFriends đã cập nhật trạng thái
        }

        // Cập nhật trạng thái người dùng
        function updateUserStatus(username, online) {
            // Cập nhật trong danh sách bạn bè
            const friendsList = document.getElementById('friend-list');
            if (friendsList) {
                const friendItems = friendsList.getElementsByClassName('friend-item');
                for (let item of friendItems) {
                    const itemUsername = item.querySelector('small').textContent.match(/@(\w+)/)[1];
                    if (itemUsername === username) {
                        const badge = item.querySelector('.badge');
                        if (badge) {
                            badge.className = `badge ${online ? 'bg-success' : 'bg-secondary'} rounded-pill`;
                            badge.textContent = online ? 'Online' : 'Offline';
                        }
                        break;
                    }
                }
            }
        }

        // Gửi thông báo đang nhập
        function sendTypingStatus(typing) {
            if (!window.stompClient || !window.stompClient.connected || !selectedUser) return;
            
            window.stompClient.send("/app/chat.typing", {}, JSON.stringify({
                sender: currentUser.username,
                receiver: selectedUser.username,
                typing: typing
            }));
        }

        // Hiển thị danh sách bạn bè
        function showFriendList() {
            const friendListContainer = document.getElementById('friend-list-container');
            const chatContainer = document.getElementById('chat-container');
            
            if (friendListContainer) {
                friendListContainer.style.display = 'block';
            }
            
            if (chatContainer) {
                chatContainer.style.display = 'none';
            }
        }

        // Chọn bạn bè để chat
        function selectFriend(friendId, friendName) {
            console.log('Selecting friend:', friendId, friendName);
            
            // Cập nhật selectedFriendId
            selectedFriendId = friendId;
            selectedFriendUsername = friendName;
            
            // Cập nhật UI
            const friendList = document.getElementById('friend-list');
            if (friendList) {
                const friendElements = friendList.getElementsByClassName('friend-item');
                for (let element of friendElements) {
                    if (element.getAttribute('data-friend-id') === friendId.toString()) {
                        element.classList.add('selected');
                    } else {
                        element.classList.remove('selected');
                    }
                }
            }
            
            // Cập nhật header và hiển thị nút unfriend
            const chatTitle = document.querySelector('.chat-title');
            if (chatTitle) {
                chatTitle.textContent = `Chat with ${friendName}`;
            }
            document.getElementById('unfriendButton').classList.remove('d-none');
            document.getElementById('deleteRoomButton').classList.add('d-none');
            
            // Hiển thị chat container
            const chatContainer = document.getElementById('chat-container');
            if (chatContainer) {
                chatContainer.style.display = 'flex';
            }
            
            // Ẩn friend list trên mobile
            const friendListContainer = document.getElementById('friend-list-container');
            if (friendListContainer) {
                friendListContainer.style.display = 'none';
            }
            
            // Load tin nhắn
            loadMessages(friendId);
        }

        // Kiểm tra lời mời kết bạn mới mỗi 30 giây
        setInterval(checkNewFriendRequests, 30000);

        // Thêm hàm kiểm tra kết nối định kỳ
        function startConnectionCheck() {
            setInterval(() => {
                if (window.stompClient && !window.stompClient.connected) {
                    console.log('Connection lost, attempting to reconnect...');
                    connectWebSocket();
                }
            }, 30000); // Kiểm tra mỗi 30 giây
        }

        // Thêm các hàm xử lý kết bạn
        function loadFriendRequests() {
            const csrf = getCsrfToken();
            if (!csrf) {
                console.error('CSRF token not found');
                return;
            }

            fetch('/api/friends/requests', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    [csrf.header]: csrf.token
                },
                credentials: 'include'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load friend requests');
                }
                return response.json();
            })
            .then(requests => {
                const container = document.getElementById('friendRequests');
                container.innerHTML = '';
                
                if (requests.length === 0) {
                    container.innerHTML = '<div class="text-center text-muted">Không có lời mời kết bạn nào</div>';
                    return;
                }

                requests.forEach(request => {
                    const requestElement = document.createElement('div');
                    requestElement.className = 'friend-request p-2 border-bottom';
                    requestElement.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${request.sender.displayName}</strong>
                                <small class="text-muted">(@${request.sender.username})</small>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-success me-2" onclick="acceptFriendRequest(${request.id})">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="rejectFriendRequest(${request.id})">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    container.appendChild(requestElement);
                });
            })
            .catch(error => {
                console.error('Error loading friend requests:', error);
                const container = document.getElementById('friendRequests');
                container.innerHTML = '<div class="text-center text-danger">Lỗi khi tải lời mời kết bạn</div>';
            });
        }

        function acceptFriendRequest(requestId) {
            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

            fetch(`/api/friendships/accept/${requestId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to accept friend request');
                }
                return response.json();
            })
            .then(data => {
                showToast('success', 'Friend request accepted');
                loadFriends();
                loadFriendRequests();
            })
            .catch(error => {
                console.error('Error accepting friend request:', error);
                showToast('error', 'Failed to accept friend request');
            });
        }

        function rejectFriendRequest(requestId) {
            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

            fetch(`/api/friendships/reject/${requestId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to reject friend request');
                }
                return response.json();
            })
            .then(data => {
                showToast('success', 'Friend request rejected');
                loadFriendRequests();
            })
            .catch(error => {
                console.error('Error rejecting friend request:', error);
                showToast('error', 'Failed to reject friend request');
            });
        }

        // Load danh sách bạn bè
        function loadFriends() {
            console.log('Loading friends...');
            const friendList = document.getElementById('friend-list');
            if (!friendList) {
                console.error('Friend list element not found');
                return;
            }

            friendList.innerHTML = '<div class="loading">Loading friends...</div>';

            fetch('/api/friendships/friends')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load friends');
                    }
                    return response.json();
                })
                .then(friends => {
                    console.log('Loaded friends:', friends);
                    friendList.innerHTML = '';
                    
                    if (friends.length === 0) {
                        friendList.innerHTML = '<div class="no-friends">No friends yet</div>';
                        return;
                    }

                    // Lọc trùng friend.id
                    const uniqueFriends = [];
                    const seenIds = new Set();
                    friends.forEach(friend => {
                        if (!seenIds.has(friend.id)) {
                            seenIds.add(friend.id);
                            uniqueFriends.push(friend);
                        }
                    });

                    uniqueFriends.forEach(friend => {
                        const friendElement = document.createElement('div');
                        friendElement.className = 'friend-item';
                        friendElement.setAttribute('data-friend-id', friend.id);
                        friendElement.innerHTML = `
                            <div class="friend-avatar">
                                <img src="${friend.avatarUrl || '/images/default-avatar.png'}" alt="${friend.username}" 
                                     onerror="this.src='/images/default-avatar.png'">
                                <span class="status-indicator ${friend.online ? 'online' : 'offline'}"></span>
                            </div>
                            <div class="friend-info">
                                <div class="friend-name">${friend.displayName || friend.username}</div>
                                <div class="friend-status">${friend.online ? 'Online' : 'Offline'}</div>
                            </div>
                        `;

                        // Thêm sự kiện click
                        friendElement.onclick = function() {
                            selectFriend(friend.id, friend.username);
                        };

                        friendList.appendChild(friendElement);
                    });
                })
                .catch(error => {
                    console.error('Error loading friends:', error);
                    showToast('error', 'Failed to load friends');
                    friendList.innerHTML = '<div class="error-message">Failed to load friends</div>';
                });
        }

        // Hàm kiểm tra lời mời kết bạn mới
        function checkNewFriendRequests() {
            const csrf = getCsrfToken();
            if (!csrf) {
                console.error('CSRF token not found');
                return;
            }

            fetch('/api/friends/requests', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    [csrf.header]: csrf.token
                },
                credentials: 'include'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to check new friend requests');
                }
                return response.json();
            })
            .then(requests => {
                if (requests && requests.length > 0) {
                    const latestRequest = requests[0];
                    showToast('info', `Bạn có lời mời kết bạn mới từ ${latestRequest.sender.displayName}`);
                    loadFriendRequests();
                }
            })
            .catch(error => {
                console.error('Error checking new friend requests:', error);
            });
        }

        // Thêm hàm hiển thị thông báo
        function showToast(type, message) {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }

        // Load danh sách người dùng online
        function loadOnlineUsers() {
            fetch('/api/chat/online-users')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load online users');
                    }
                    return response.json();
                })
                .then(users => {
                    const onlineUsersList = document.getElementById('onlineUsersList');
                    onlineUsersList.innerHTML = '';
                    
                    if (users.length === 0) {
                        onlineUsersList.innerHTML = '<div class="text-center text-muted">No users online</div>';
                        return;
                    }
                    
                    users.forEach(user => {
                        const userItem = document.createElement('div');
                        userItem.className = 'list-group-item';
                        userItem.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${user.username}</strong>
                                    <small class="text-muted d-block">@${user.username}</small>
                                </div>
                                <button class="btn btn-sm btn-primary" onclick="sendFriendRequest('${user.username}')">
                                    <i class="fas fa-user-plus"></i>
                                </button>
                            </div>
                        `;
                        onlineUsersList.appendChild(userItem);
                    });
                })
                .catch(error => {
                    console.error('Error loading online users:', error);
                    const onlineUsersList = document.getElementById('onlineUsersList');
                    onlineUsersList.innerHTML = '<div class="text-center text-danger">Failed to load online users</div>';
                });
        }

        // Tìm kiếm người dùng
        function searchUsers() {
            const searchInput = document.getElementById('searchInput');
            const query = searchInput.value.trim();
            
            if (!query) {
                return;
            }
            
            fetch(`/api/users/search?query=${encodeURIComponent(query)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to search users');
                    }
                    return response.json();
                })
                .then(users => {
                    const searchResults = document.getElementById('searchResults');
                    searchResults.innerHTML = '';
                    
                    if (users.length === 0) {
                        searchResults.innerHTML = '<div class="text-center text-muted">No users found</div>';
                        return;
                    }
                    
                    users.forEach(user => {
                        const userItem = document.createElement('div');
                        userItem.className = 'list-group-item';
                        userItem.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${user.username}</strong>
                                    <small class="text-muted d-block">@${user.username}</small>
                                </div>
                                <button class="btn btn-sm btn-primary" onclick="sendFriendRequest('${user.username}')">
                                    <i class="fas fa-user-plus"></i>
                                </button>
                            </div>
                        `;
                        searchResults.appendChild(userItem);
                    });
                })
                .catch(error => {
                    console.error('Error searching users:', error);
                    const searchResults = document.getElementById('searchResults');
                    searchResults.innerHTML = '<div class="text-center text-danger">Failed to search users</div>';
                });
        }

        // Gửi lời mời kết bạn
        function sendFriendRequest(username) {
            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

            fetch(`/api/friendships/request/${username}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Failed to send friend request');
                    });
                }
                return response.json();
            })
            .then(data => {
                showToast('success', data.message || 'Friend request sent successfully');
                loadFriendRequests(); // Reload friend requests
            })
            .catch(error => {
                console.error('Error sending friend request:', error);
                showToast('error', error.message || 'Failed to send friend request');
            });
        }

        // Cập nhật danh sách người dùng online định kỳ
        setInterval(loadOnlineUsers, 30000); // Cập nhật mỗi 30 giây

        // Load danh sách người dùng online khi chuyển tab
        document.querySelector('a[data-bs-target="#onlineUsers"]').addEventListener('click', loadOnlineUsers);

        // Load danh sách phòng chat
        function loadRooms() {
            const roomList = document.getElementById('room-list');
            if (!roomList) return;
            roomList.innerHTML = '<div class="loading">Loading rooms...</div>';
            fetch('/api/rooms', { credentials: 'include' })
                .then(response => {
                    if (!response.ok) throw new Error('Failed to load rooms');
                    return response.json();
                })
                .then(rooms => {
                    roomList.innerHTML = '';
                    if (rooms.length === 0) {
                        roomList.innerHTML = '<div class="no-rooms">No rooms yet</div>';
                        return;
                    }
                    rooms.forEach(room => {
                        const roomElement = document.createElement('div');
                        roomElement.className = 'friend-item';
                        roomElement.setAttribute('data-room-id', room.id);
                        roomElement.innerHTML = `
                            <div class="friend-avatar">
                                <img src="/images/default-avatar.png" alt="room">
                            </div>
                            <div class="friend-info">
                                <div class="friend-name">${room.name}</div>
                                <div class="friend-status">${room.description || ''}</div>
                            </div>
                        `;
                        roomElement.onclick = function() {
                            console.log('Click room:', room.id, room.name);
                            selectRoom(room.id, room.name);
                        };
                        roomList.appendChild(roomElement);
                    });
                })
                .catch(error => {
                    roomList.innerHTML = '<div class="error-message">Failed to load rooms</div>';
                });
        }

        // Định nghĩa tất cả các hàm trước
        function selectRoom(roomId, roomName) {
            console.log('Selecting room:', roomId, roomName);
            // Cập nhật UI NGAY LẬP TỨC
            window.selectedRoomId = roomId;
            window.selectedRoomName = roomName;
            // Highlight phòng đang chọn
            const roomList = document.getElementById('room-list');
            if (roomList) {
                const roomElements = roomList.getElementsByClassName('friend-item');
                for (let element of roomElements) {
                    if (element.getAttribute('data-room-id') === roomId.toString()) {
                        element.classList.add('selected');
                    } else {
                        element.classList.remove('selected');
                    }
                }
            }
            // Cập nhật header và hiển thị nút delete room
            const chatTitle = document.querySelector('.chat-title');
            if (chatTitle) {
                chatTitle.textContent = `Room: ${roomName}`;
            }
            document.getElementById('deleteRoomButton').classList.remove('d-none');
            document.getElementById('unfriendButton').classList.add('d-none');
            // Xóa nội dung tin nhắn cũ
            const messagesContainer = document.getElementById('messages');
            if (messagesContainer) messagesContainer.innerHTML = '';
            // Nếu chưa kết nối WebSocket thì chỉ dừng ở đây
            if (!window.stompClient || !window.stompClient.connected) {
                window.pendingRoom = { id: roomId, name: roomName };
                connectWebSocket();
                return;
            }
            window.pendingRoom = null;
            // Subscribe vào topic phòng trước
            subscribeRoomTopic(roomId).then(() => {
                console.log('Đã subscribe, bắt đầu load tin nhắn phòng', roomId);
                loadRoomMessages(roomId);
            }).catch(error => {
                console.error('Lỗi khi vào phòng chat:', error);
                showToast('error', 'Không thể vào phòng chat, vui lòng thử lại');
            });
        }

        function loadRoomMessages(roomId) {
            const messagesContainer = document.getElementById('messages');
            if (!messagesContainer) return;
            messagesContainer.innerHTML = '';
            fetch(`/api/rooms/${roomId}/messages`, { credentials: 'include' })
                .then(response => {
                    if (!response.ok) throw new Error('Failed to load room messages');
                    return response.json();
                })
                .then(messages => {
                    messages.forEach(msg => {
                        messagesContainer.innerHTML += renderRoomMessage(msg);
                    });
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                })
                .catch(error => {
                    messagesContainer.innerHTML = '<div class="error-message">Failed to load room messages</div>';
                });
        }

        function subscribeRoomTopic(roomId) {
            return new Promise((resolve, reject) => {
                if (!roomId) {
                    reject(new Error('Room ID is required for subscription'));
                    return;
                }

                // Kiểm tra và khởi tạo kết nối WebSocket nếu cần
                if (!window.stompClient || !window.stompClient.connected) {
                    console.warn('WebSocket chưa kết nối, đang kết nối lại...');
                    // Lưu roomId để subscribe sau khi kết nối thành công
                    window.pendingRoomSubscription = roomId;
                    connectWebSocket();
                    reject(new Error('WebSocket not connected'));
                    return;
                }

                // Hủy subscription cũ nếu có
                if (!window.roomSubscriptions) window.roomSubscriptions = {};
                if (window.roomSubscriptions[roomId]) {
                    try {
                        window.roomSubscriptions[roomId].unsubscribe();
                    } catch (e) {
                        console.warn('Error unsubscribing from previous room:', e);
                    }
                }

                // Subscribe vào topic mới
                try {
                    window.roomSubscriptions[roomId] = window.stompClient.subscribe(
                        `/topic/room.${roomId}`,
                        function(payload) {
                            try {
                                const message = JSON.parse(payload.body);
                                console.log('Nhận tin nhắn phòng:', message);
                                const messagesContainer = document.getElementById('messages');
                                if (messagesContainer) {
                                    messagesContainer.innerHTML += renderRoomMessage(message);
                                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                                }
                            } catch (e) {
                                console.error('Lỗi xử lý tin nhắn phòng:', e);
                                showToast('error', 'Có lỗi khi hiển thị tin nhắn');
                            }
                        },
                        {
                            id: `